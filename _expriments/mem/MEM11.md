# MEM11 - 情绪特定工作流功能实现记忆

## 关键修改

1. **工作流加载逻辑**
   - 修改了`_load_workflow_from_file`方法，增强了错误处理和日志记录
   - 实现了多层次的回退机制：情绪特定工作流 → 默认工作流 → 硬编码工作流
   - 添加了文件存在性检查和详细的日志输出

2. **情绪工作流映射**
   - 实现了根据情绪类型动态加载工作流文件的功能
   - 文件命名约定：`{emotion}.json`（如`happy.json`、`sad.json`等）
   - 如果特定情绪的工作流文件不存在，则使用默认的`test.json`

3. **工作流目录结构**
   - 确认了工作流目录位置：`src/_backend/workflows/`
   - 添加了目录存在性检查和自动创建功能
   - 更新了`arc.md`文件，添加了情绪工作流文件的描述

4. **API增强**
   - 改进了API路由中的错误处理
   - 添加了详细的日志记录，便于调试和监控
   - 增加了对工作流为空的检查
   - 修改了提示词提取逻辑，不再假设提示词一定在节点6中

5. **提示词处理**
   - 移除了强制替换工作流中提示词的逻辑
   - 保留了工作流文件中的原始提示词
   - 只有当用户提供了自定义提示词时，才会在原始提示词的基础上添加
   - 硬编码的默认工作流仍然使用情绪到提示词的映射（作为备用方案）

## 工作流文件格式

ComfyUI工作流是一个JSON对象，包含多个节点及其连接关系。一个典型的情绪工作流应包含以下节点：

1. **CheckpointLoaderSimple** - 加载模型权重
2. **EmptyLatentImage** - 创建空白潜在图像
3. **CLIPTextEncode** (正面提示词) - 将情绪相关提示词转换为CLIP嵌入
4. **CLIPTextEncode** (负面提示词) - 将负面提示词转换为CLIP嵌入
5. **KSampler** - 执行扩散采样过程
6. **VAEDecode** - 将潜在图像转换为RGB图像
7. **SaveImage** - 保存生成的图像

## 使用方法

1. **创建情绪工作流**
   - 在ComfyUI中设计特定情绪的工作流
   - 导出工作流JSON文件
   - 将文件保存为`{emotion}.json`到`src/_backend/workflows/`目录
   - 工作流中的提示词将被完全保留，不会被系统替换

2. **API调用**
   - 调用`/api/v1/generation/from-emotion`端点
   - 提供情绪类型、强度和可选的自定义提示词
   - 系统会自动加载对应的工作流文件

3. **自定义提示词**
   - 如果用户提供了自定义提示词，系统会将其添加到工作流中的原始提示词之后
   - 如果没有提供自定义提示词，工作流中的原始提示词将被完全保留

## 支持的情绪类型

系统支持以下情绪类型的工作流：

1. **happy** - 快乐、喜悦
2. **sad** - 悲伤、忧郁
3. **angry** - 愤怒、烦躁
4. **surprised** - 惊讶、震惊
5. **neutral** - 中性、平静
6. **disgusted** - 厌恶、反感
7. **fearful** - 恐惧、害怕

## 注意事项

- 工作流文件必须是有效的ComfyUI工作流JSON格式
- 文件名必须与情绪类型匹配（全小写）
- 如果找不到特定情绪的工作流文件，系统会自动使用默认的`test.json`
- 如果默认工作流也不存在，系统会使用硬编码的默认工作流（此时会使用情绪到提示词的映射）
- 确保工作流中包含可识别的CLIPTextEncode和SaveImage节点，以便系统能够正确处理自定义提示词和文件名前缀 