# EmoScan 项目架构文档 (arc.md)

## 📁 项目目录结构

```
faceana-mtq/                           # 项目根目录
├── 📁 src/                           # 源代码目录
│   ├── 📁 _frontend/                 # 前端桌面应用
│   │   ├── 📁 app/                   # Next.js 应用目录
│   │   │   ├── 📄 layout.tsx         # 应用布局组件
│   │   │   ├── 📄 page.tsx           # 主页面组件 (1176行)
│   │   │   ├── 📄 globals.css        # 全局样式
│   │   │   └── 📄 client-body-class.tsx # 客户端body类
│   │   ├── 📁 components/            # React 组件库
│   │   │   ├── 📁 ui/                # 基础UI组件 (40+个)
│   │   │   │   ├── 📄 button.tsx     # 按钮组件
│   │   │   │   ├── 📄 card.tsx       # 卡片组件
│   │   │   │   ├── 📄 dialog.tsx     # 对话框组件
│   │   │   │   └── 📄 ...            # 其他UI组件
│   │   │   ├── 📁 camera/            # 摄像头相关组件
│   │   │   ├── 📁 emotion/           # 情感分析组件
│   │   │   ├── 📁 ai-output/         # AI输出组件
│   │   │   ├── 📁 hooks/             # 自定义Hooks
│   │   │   ├── 📄 ThemeToggle.tsx    # 主题切换组件
│   │   │   └── 📄 theme-provider.tsx # 主题提供者
│   │   ├── 📁 electron/              # Electron 主进程
│   │   │   └── 📄 main.js            # Electron 入口
│   │   ├── 📁 hooks/                 # 自定义React Hooks
│   │   ├── 📁 lib/                   # 工具库
│   │   ├── 📁 styles/                # 样式文件
│   │   ├── 📁 public/                # 静态资源
│   │   ├── 📁 out/                   # 构建输出
│   │   ├── 📄 package.json           # 前端依赖配置
│   │   ├── 📄 next.config.mjs        # Next.js 配置
│   │   ├── 📄 tailwind.config.ts     # Tailwind 配置
│   │   ├── 📄 tsconfig.json          # TypeScript 配置
│   │   └── 📄 README.md              # 前端说明文档
│   └── 📁 _backend/                  # 后端API服务
│       ├── 📁 app/                   # FastAPI 应用
│       │   ├── 📄 __init__.py        # 包初始化
│       │   ├── 📄 main.py            # 主应用入口 (259行)
│       │   ├── 📁 api/               # API路由
│       │   │   ├── 📄 __init__.py    # API包初始化
│       │   │   └── 📁 v1/            # API v1版本
│       │   ├── 📁 models/            # 数据模型
│       │   │   ├── 📄 __init__.py    # 模型包初始化
│       │   │   ├── 📄 emotion.py     # 情感数据模型
│       │   │   └── 📄 comfyui.py     # ComfyUI数据模型
│       │   ├── 📁 services/          # 业务服务
│       │   │   ├── 📄 __init__.py    # 服务包初始化
│       │   │   ├── 📄 emotion_analyzer.py # 情感分析服务
│       │   │   ├── 📄 comfyui_service.py  # ComfyUI服务
│       │   │   ├── 📄 ai_service.py       # AI服务
│       │   │   └── 📄 facepp_service.py   # Face++服务
│       │   └── 📁 utils/             # 工具函数
│       ├── 📁 config/                # 配置文件
│       ├── 📁 workflows/             # ComfyUI工作流
│       ├── 📄 start_server.py        # 服务器启动脚本
│       ├── 📄 requirements.txt       # Python依赖 (10个包)
│       └── 📄 pyproject.toml         # 项目配置 (30行)
├── 📁 comfyui/                       # ComfyUI集成
│   ├── 📁 custom_nodes/              # 自定义节点
│   │   ├── 📁 comfyui-jimeng-api/    # 即梦API节点
│   │   └── 📁 other_node/            # 其他自定义节点
│   └── 📁 other/                     # 其他ComfyUI文件
├── 📁 docs/                          # 项目文档
│   ├── 📄 stack.md                   # 技术栈文档 (292行)
│   ├── 📄 api-documents.md           # API文档
│   ├── 📄 idea.md                    # 项目想法
│   ├── 📄 logic.md                   # 逻辑设计
│   ├── 📄 agent.md                   # 代理文档
│   ├── 📁 app/                       # 应用文档
│   │   └── 📄 UI界面截图.png         # 界面截图
│   └── 📁 obsidian/                  # Obsidian笔记
│       └── 📄 程序执行流程.canvas    # 流程图
├── 📁 test/                          # 测试文件
│   ├── 📄 README.md                  # 测试说明
│   ├── 📁 api_tests/                 # API测试
│   ├── 📁 frontend_tests/            # 前端测试
│   ├── 📁 integration_tests/         # 集成测试
│   ├── 📁 debug_tools/               # 调试工具
│   ├── 📁 monitoring_tools/          # 监控工具
│   ├── 📁 assets/                    # 测试资源
│   ├── 📄 debug_comfyui_status.py    # ComfyUI状态调试
│   └── 📄 fix_workflows.py           # 工作流修复
├── 📁 _expriments/                   # 开发实验记录
│   ├── 📁 exp/                       # 经验总结 (29个文件)
│   │   ├── 📄 EXP1.md ~ EXP29.md     # 经验记录文件
│   ├── 📁 sum/                       # 对话总结 (26个文件)
│   │   ├── 📄 SUM1.md ~ SUM26.md     # 对话总结文件
│   └── 📁 mem/                       # 记忆存储 (17个文件)
│       ├── 📄 MEM9.md ~ MEM25.md     # 记忆文件
├── 📁 output/                        # 输出文件
│   └── 📄 output.jpeg                # 生成的图像
├── 📄 README.md                      # 项目主文档
├── 📄 arc.md                         # 项目架构文档 (本文件)
├── 📄 package-lock.json              # 根目录依赖锁定
└── 📄 requirements.txt               # 根目录Python依赖
```

## 🏗️ 架构设计

### 1. 前端架构 (Next.js + Electron)

```
┌─────────────────────────────────────────────────────────────┐
│                    Electron 桌面应用                        │
├─────────────────────────────────────────────────────────────┤
│                    Next.js 应用层                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   摄像头    │  │   情感分析   │  │  AI输出     │        │
│  │   组件      │  │   组件      │  │  组件       │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│                    React 组件层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  UI组件库   │  │  自定义Hook │  │  主题系统   │        │
│  │ (Radix UI)  │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│                  Tailwind CSS 样式层                       │
└─────────────────────────────────────────────────────────────┘
```

### 2. 后端架构 (FastAPI)

```
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI 应用层                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  API路由    │  │  中间件     │  │  静态文件   │        │
│  │             │  │  (CORS)     │  │  服务       │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│                    业务服务层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  情感分析   │  │  ComfyUI    │  │  AI服务     │        │
│  │  服务       │  │  服务       │  │  集成       │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│                    数据模型层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Pydantic   │  │  情感模型   │  │  ComfyUI    │        │
│  │  验证       │  │             │  │  模型       │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 3. AI集成架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AI服务集成层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  OpenAI     │  │  Face++     │  │  ComfyUI    │        │
│  │  API        │  │  API        │  │  工作流     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│                    数据处理层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  图像预处理 │  │  情感分析   │  │  结果聚合   │        │
│  │             │  │  算法       │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 数据流程

### 1. 情感分析流程

```
用户启动扫描 → 摄像头捕获 → 图像处理 → AI分析 → 结果展示
     ↓              ↓           ↓         ↓         ↓
  前端UI交互    Canvas处理   FastAPI    多AI服务   实时更新
```

### 2. 图像生成流程

```
情感分析结果 → 工作流选择 → ComfyUI调用 → 图像生成 → 结果返回
     ↓              ↓           ↓           ↓         ↓
  情感映射      工作流文件   HTTP请求    GPU处理   文件保存
```

## 📊 技术栈统计

### 前端技术栈
- **框架**: Next.js 15.2.4 + React 19 + TypeScript 5
- **桌面**: Electron 36.3.2
- **样式**: Tailwind CSS 3.4.17 + Radix UI
- **组件**: 40+ UI组件 + 自定义组件
- **包管理**: npm + pnpm

### 后端技术栈
- **框架**: FastAPI 0.104.1 + Uvicorn 0.24.0
- **语言**: Python 3.8+
- **AI集成**: OpenAI API + Face++ API
- **图像处理**: Pillow 10.1.0
- **包管理**: uv + pip

### 开发工具
- **测试**: pytest + httpx
- **文档**: Markdown + Obsidian
- **版本控制**: Git + GitHub
- **构建**: Electron Builder + Next.js

## 📈 项目规模

- **总文件数**: 100+ 文件
- **代码行数**: 
  - 前端主页面: 1,176 行
  - 后端主应用: 259 行
  - 技术栈文档: 292 行
- **依赖包数**:
  - 前端: 60+ npm 包
  - 后端: 10+ Python 包
- **开发记录**: 70+ 实验文档

---

*最后更新: 2025年6月8日*
*架构版本: v1.0.0*
